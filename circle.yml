machine:
  services:
    - docker
  php:
      version: 5.6.14
dependencies:
  pre:
    - sudo apt-get install sshpass
    - sudo chmod u+x ./docker/entrypoint.sh
    - sudo chmod 777 ./bin/tests/import_test_data_stage.sh
    - sudo chmod -R 766 ./docker/config
    - npm install -g casperjs@1.1.4
    - npm install -g junit-viewer
    - npm install -g bower
    - npm install -g phantomjs-prebuilt@2.1.16
    - npm install -g junit-viewer
    - npm install yamljs
    - sed -i -e "s/{MIRAKL_CONNECTOR_ACCOUNT_OPERATOR_EMAIL\}/$MIRAKL_CONNECTOR_ACCOUNT_OPERATOR_EMAIL/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_ACCOUNT_OPERATOR_HIPAY_ID\}/$MIRAKL_CONNECTOR_ACCOUNT_OPERATOR_HIPAY_ID/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_ACCOUNT_TECHNICAL_EMAIL\}/$MIRAKL_CONNECTOR_ACCOUNT_TECHNICAL_EMAIL/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_ACCOUNT_TECHNICAL_HIPAY_ID\}/$MIRAKL_CONNECTOR_ACCOUNT_TECHNICAL_HIPAY_ID/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_HIPAY_BASE_SOAP_URL\}/$MIRAKL_CONNECTOR_HIPAY_BASE_SOAP_URL/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_HIPAY_ENTITY\}/$MIRAKL_CONNECTOR_HIPAY_ENTITY/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_HIPAY_MERCHANT_GROUP_ID\}/$MIRAKL_CONNECTOR_HIPAY_MERCHANT_GROUP_ID/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_HIPAY_WS_LOGIN\}/$MIRAKL_CONNECTOR_HIPAY_WS_LOGIN/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_HIPAY_WS_PASSWORD\}/$MIRAKL_CONNECTOR_HIPAY_WS_PASSWORD/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_MIRAKL_BASE_URL\}/$MIRAKL_CONNECTOR_MIRAKL_BASE_URL/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_MIRAKL_FRONT_KEY\}/$MIRAKL_CONNECTOR_MIRAKL_FRONT_KEY/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_MIRAKL_OPERATOR_KEY\}/$MIRAKL_CONNECTOR_MIRAKL_OPERATOR_KEY/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_MIRAKL_SHOP_KEY\}/$MIRAKL_CONNECTOR_MIRAKL_SHOP_KEY/" ./docker/conf/stage/hipay.env.dist
    - sed -i -e "s/{MIRAKL_CONNECTOR_HIPAY_BASE_REST_URL\}/$MIRAKL_CONNECTOR_HIPAY_BASE_REST_URL/" ./docker/conf/stage/hipay.env.dist
    - docker-compose -f docker-compose.yml -f docker-compose.stage.yml build
    - docker-compose -f docker-compose.yml -f docker-compose.stage.yml up -d
    - mkdir $CIRCLE_ARTIFACTS/casper_report
    - mkdir $CIRCLE_ARTIFACTS/screenshots
  override:
      - echo "override to not run composer install"
      - sh ./bin/deployment/setup_sonar.sh
test:
  post:
      - cp bin/tests/report*.html $CIRCLE_ARTIFACTS/casper_report/
      - sh ./bin/deployment/sonar.sh > /dev/null
  override:
     - sleep 100
     - curl --retry 10 --retry-delay 5 -v http://localhost:8080
     - sudo lxc-attach -n "$(docker inspect --format "{{.Id}}" hipay-mirakl-running)" -- bash -c /var/www/html/bin/tests/import_test_data_stage.sh
     - sh bin/tests/casper_run_circle.sh
     - sh ./bin/tests/report-test.sh
deployment:
  prod:
    branch: /.*?/
    tag: /.*?/
    commands:
      - sh ./bin/deployment/deploy_project.sh
